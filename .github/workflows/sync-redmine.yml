name: Sync Redmine

on:
  workflow_dispatch:
  schedule:
    # Run every day at 7:30 JST
    - cron: "30 22 * * *"

permissions:
  contents: write
  actions: write

concurrency:
  group: sync-redmine
  cancel-in-progress: false

env:
  REDMICA_BRANCH: master

jobs:
  sync-redmine:
    runs-on: ubuntu-latest

    steps:
      - name: Check branch for workflow run
        run: |
          if [ "${GITHUB_REF_NAME}" != "${REDMICA_BRANCH}" ]; then
            echo "This workflow must run on ${REDMICA_BRANCH}, got ${GITHUB_REF_NAME}" >&2
            exit 1
          fi

      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout RedMica
        uses: actions/checkout@v6
        with:
          ref: ${{ env.REDMICA_BRANCH }}
          path: redmica
          token: ${{ steps.app-token.outputs.token }}

      - name: Checkout Redmine
        uses: actions/checkout@v6
        with:
          repository: redmine/redmine
          fetch-depth: 0
          path: redmine

      - name: Validate REDMINE_LAST_SYNCED_COMMIT
        working-directory: redmine
        run: |
          if [ -z "${{ vars.REDMINE_LAST_SYNCED_COMMIT }}" ]; then
            echo "Repository variable REDMINE_LAST_SYNCED_COMMIT is not set" >&2
            exit 1
          fi
          if ! git cat-file -e "${{ vars.REDMINE_LAST_SYNCED_COMMIT }}^{commit}"; then
            echo "REDMINE_LAST_SYNCED_COMMIT does not exist: ${{ vars.REDMINE_LAST_SYNCED_COMMIT }}" >&2
            exit 1
          fi
          if ! git merge-base --is-ancestor "${{ vars.REDMINE_LAST_SYNCED_COMMIT }}" HEAD; then
            echo "REDMINE_LAST_SYNCED_COMMIT is not an ancestor of HEAD: ${{ vars.REDMINE_LAST_SYNCED_COMMIT }}" >&2
            exit 1
          fi

      - name: Get Redmine HEAD commit
        working-directory: redmine
        run: |
          echo "REDMINE_HEAD_COMMIT=$(git rev-parse HEAD)" >> ${GITHUB_ENV}

      - name: Check for new Redmine commits
        working-directory: redmine
        run: |
          if [ "$(git rev-list --count ${{ vars.REDMINE_LAST_SYNCED_COMMIT }}..HEAD)" -eq 0 ]; then
            echo "REDMINE_HAS_DIFF=false" >> ${GITHUB_ENV}
          else
            echo "REDMINE_HAS_DIFF=true" >> ${GITHUB_ENV}
          fi

      - name: Generate Redmine patches
        if: env.REDMINE_HAS_DIFF == 'true'
        working-directory: redmine
        env:
          FILTER_BRANCH_SQUELCH_WARNING: 1
        run: |
          # Rewrite issue references from #1234 to redmine-1234 inside commit messages
          git filter-branch --msg-filter 'sed -e "s/\([[:punct:][:space:]]\)#\([0-9]*\)\([[:punct:][:space:]]\)/\1redmine-\2\3/g"' -f ${{ vars.REDMINE_LAST_SYNCED_COMMIT }}..HEAD

          git log --oneline ${{ vars.REDMINE_LAST_SYNCED_COMMIT }}..HEAD

          # Emit one patch per commit
          git format-patch ${{ vars.REDMINE_LAST_SYNCED_COMMIT }}

      - name: Configure Git author
        if: env.REDMINE_HAS_DIFF == 'true'
        env:
          GIT_USER_NAME: "redmica-sync[bot]"
          GIT_USER_EMAIL: "redmica-sync[bot]@users.noreply.github.com"
        run: |
          git config --global user.email ${GIT_USER_EMAIL}
          git config --global user.name ${GIT_USER_NAME}

      - name: Apply patches to RedMica and update synced Redmine commit ID
        if: env.REDMINE_HAS_DIFF == 'true'
        working-directory: redmica
        env:
          REDMINE_LAST_SYNCED_COMMIT: ${{ vars.REDMINE_LAST_SYNCED_COMMIT }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        shell: bash
        run: |
          update_redmine_last_synced_commit() {
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              /repos/${GITHUB_REPOSITORY}/actions/variables/REDMINE_LAST_SYNCED_COMMIT \
              -f name=REDMINE_LAST_SYNCED_COMMIT \
              -f value="$1"
          }

          git switch ${REDMICA_BRANCH}

          # Apply the Redmine patches
          git am ${GITHUB_WORKSPACE}/redmine/*.patch --exclude=doc/CHANGELOG
          git log --oneline -n 50

          # Update REDMINE_LAST_SYNCED_COMMIT repo variable to the new synced commit
          update_redmine_last_synced_commit "${REDMINE_HEAD_COMMIT}"

          if ! git push origin ${REDMICA_BRANCH}; then
            echo "git push failed"
            update_redmine_last_synced_commit "${REDMINE_LAST_SYNCED_COMMIT}" || echo "Failed to roll back REDMINE_LAST_SYNCED_COMMIT. Please verify the variable value manually."
            exit 1
          fi
